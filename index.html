<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒã‚«ãƒãƒ³â˜…SPACE</title>
    <link rel="stylesheet" href="./css/reset.css">
    <link rel="stylesheet" href="./css/style.css">
    <link href="https://fonts.googleapis.com/earlyaccess/nicomoji.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
</head>

<body>

    <!-- ãƒ­ã‚°ã‚¤ãƒ³ãƒ»æ–°è¦ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ ã®ã‚³ãƒ³ãƒ†ãƒŠ -->
    <div id="login-container" style="display: none;">
        <h2>ğŸ’€ãƒã‚«ãƒãƒ³æ©Ÿå¯†æƒ…å ±ã«æ¥ç¶šğŸ’€</h2>
        <input type="email" id="login-email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹">
        <input type="password" id="login-password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
        <button id="login-button">ãƒ­ã‚°ã‚¤ãƒ³</button>
        <!-- æ–°è¦ç™»éŒ²ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <h2>ğŸš€æ–°è¦ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ç™»éŒ²ğŸŒ</h2>
        <input type="email" id="signup-email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹">
        <input type="password" id="signup-password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
        <button id="signup-button">ç™»éŒ²</button>
    </div>

    <!-- ãƒ­ã‚°ã‚¤ãƒ³å¾Œã«è¡¨ç¤ºã•ã‚Œã‚‹ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ã‚³ãƒ³ãƒ†ãƒŠ -->
    <div id="content-container" style="display: none;">
        <h1>ãƒã‚«ãƒãƒ³<span>â˜…</span>SPACE</h1>
        <h2>ï½ è‡³æ€¥ã€å›½éš›å®‡å®™ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆISSï¼‰ã¸æ€¥è¡Œã›ã‚ˆï¼ã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è·é›¢ï¼†æ°—å€™æƒ…å ±ã€‘ï½</h2>
        <!-- ISSã¾ã§ã®è·é›¢æƒ…å ± -->
        <p id="distanceInfo"></p>
        <!-- æ°—å€™æƒ…å ± -->
        <div id="weatherInfo">
            <div>ï¼ ISS</div>
            <div id="issWeather">ISSä½ç½®ã®æ°—å€™: èª­ã¿è¾¼ã¿ä¸­...</div>
            <div id="bakachinInfo">ï¼ ãƒã‚«ãƒãƒ³ã‚¬ãƒ¼</div>
            <div id="userWeather">ãƒã‚«ãƒãƒ³ã‚¬ãƒ¼ä½ç½®ã®æ°—å€™: èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>
        <!-- åœ°å›³è¡¨ç¤ºç”¨ã®ã‚³ãƒ³ãƒ†ãƒŠ -->
        <div id="map"></div>
        <!-- ISSã«é–¢ã™ã‚‹è±†çŸ¥è­˜ -->
        <div>
            <li>ã€è±†çŸ¥è­˜ã€‘ISSã¯ç´„400kmä¸Šç©ºã®è»Œé“ã§ç´„90åˆ†ã§åœ°çƒã‚’ä¸€å‘¨ã—ã¦ã‚‹ã‚ˆ</li>
        </div>
        <!-- ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³ -->
        <button id="logout-button" style="display: none;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>

    <!-- jQueryã®èª­ã¿è¾¼ã¿ -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Firebaseã®èª­ã¿è¾¼ã¿ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import {
            getAuth,
            signInWithEmailAndPassword,
            createUserWithEmailAndPassword,
            onAuthStateChanged,
            signOut
        } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";

        // Firebaseã®è¨­å®šæƒ…å ±
        const firebaseConfig = {
            apiKey: "ã“ã“ã«API_KEYã‚’å…¥åŠ›",
            authDomain: "bakachin-iss.firebaseapp.com",
            databaseURL: "https://bakachin-iss-default-rtdb.firebaseio.com",
            projectId: "bakachin-iss",
            storageBucket: "bakachin-iss.appspot.com",
            messagingSenderId: "358303450781",
            appId: "1:358303450781:web:3c112f539c2ccc4bf8b674"
        };

        // Firebaseã®åˆæœŸåŒ–
        const app = initializeApp(firebaseConfig);
        const auth = getAuth();

        // ãƒ­ã‚°ã‚¤ãƒ³é–¢æ•°
        function loginUser(email, password) {
            signInWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    // ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸæ™‚ã®å‡¦ç†
                    console.log("Logged in as: ", userCredential.user);
                    $('#login-container').hide(); // ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ ã‚’éš ã™
                    $('#content-container').show(); // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç”»é¢ã‚’è¡¨ç¤º
                    $('#logout-button').show(); // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                })
                .catch((error) => {
                    // ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—æ™‚ã®å‡¦ç†
                    console.error("Login failed: ", error);
                });
        }

        // æ–°è¦ç™»éŒ²é–¢æ•°
        function signUpUser(email, password) {
            createUserWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    // æ–°è¦ç™»éŒ²æˆåŠŸæ™‚ã®å‡¦ç†
                    console.log("Account created for: ", userCredential.user);
                })
                .catch((error) => {
                    // æ–°è¦ç™»éŒ²å¤±æ•—æ™‚ã®å‡¦ç†
                    console.error("Error in account creation: ", error);
                });
        }

        // ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã®å¤‰æ›´ã‚’ç›£è¦–
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹å ´åˆã®å‡¦ç†
                console.log("User is logged in: ", user);
            } else {
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¦ã„ã‚‹å ´åˆã®å‡¦ç†
                console.log("User is logged out");
            }
        });

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆé–¢æ•°
        function logoutUser() {
            signOut(auth)
                .then(() => {
                    // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæˆåŠŸæ™‚ã®å‡¦ç†
                    console.log("User logged out");
                })
                .catch((error) => {
                    // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå¤±æ•—æ™‚ã®å‡¦ç†
                    console.error("Error in logging out: ", error);
                });
        }

        // ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã«å¿œã˜ã¦è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹å ´åˆ
                $('#login-container').hide();
                $('#content-container').show();
                $('#logout-button').show();
            } else {
                // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¦ã„ã‚‹å ´åˆ
                $('#login-container').show();
                $('#content-container').hide();
                $('#logout-button').hide();
            }
        });

        // ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
        $('#login-button').on('click', function () {
            const email = $('#login-email').val();
            const password = $('#login-password').val();
            loginUser(email, password);
        });

        // æ–°è¦ç™»éŒ²ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
        $('#signup-button').on('click', function () {
            const email = $('#signup-email').val();
            const password = $('#signup-password').val();
            signUpUser(email, password);
        });

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
        $('#logout-button').on('click', function () {
            logoutUser();
        });
    </script>

    <script>
        let map;
        let issMarker, userMarker;
        let issInfoWindow, userInfoWindow;
        let issLat = 0;
        let issLng = 0;
        let userLat, userLng;

        // åœ°å›³ã®åˆæœŸåŒ–é–¢æ•°
        function initMap() {
            map = new google.maps.Map($('#map')[0], {
                center: { lat: 0, lng: 0 },
                zoom: 2
            });

            issMarker = new google.maps.Marker({
                position: { lat: 0, lng: 0 },
                map: map,
                title: 'å›½éš›å®‡å®™ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆISSï¼‰'
            });

            issInfoWindow = new google.maps.InfoWindow({
                content: 'å›½éš›å®‡å®™ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆISSï¼‰'
            });

            issMarker.addListener('click', function () {
                issInfoWindow.open(map, issMarker);
            });

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function (position) {
                    userLat = position.coords.latitude;
                    userLng = position.coords.longitude;

                    userMarker = new google.maps.Marker({
                        position: { lat: userLat, lng: userLng },
                        map: map,
                        title: 'ãƒã‚«ãƒãƒ³ã‚¬ãƒ¼ç¾åœ¨åœ°'
                    });

                    userInfoWindow = new google.maps.InfoWindow({
                        content: 'ãƒã‚«ãƒãƒ³ã‚¬ãƒ¼ç¾åœ¨åœ°'
                    });

                    userMarker.addListener('click', function () {
                        userInfoWindow.open(map, userMarker);
                    });

                    updateISS();
                }, function () {
                    handleLocationError(true, map.getCenter());
                });
            } else {
                // ãƒ–ãƒ©ã‚¦ã‚¶ãŒGeolocationã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ãªã„å ´åˆã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
                handleLocationError(false, map.getCenter());
            }
        }

        let line;

        // ISSã®ä½ç½®æƒ…å ±ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
        function updateISS() {
            $.getJSON('http://api.open-notify.org/iss-now.json', function (data) {
                issLat = parseFloat(data.iss_position.latitude);
                issLng = parseFloat(data.iss_position.longitude);

                issMarker.setPosition(new google.maps.LatLng(issLat, issLng));
                map.panTo(new google.maps.LatLng(issLat, issLng));

                issInfoWindow.setContent('å›½éš›å®‡å®™ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆISSï¼‰<br>ç·¯åº¦: ' + issLat.toFixed(2) + ', çµŒåº¦: ' + issLng.toFixed(2));

                if (userLat !== undefined && userLng !== undefined) {
                    let distance = calculateDistance(userLat, userLng, issLat, issLng);
                    $('#distanceInfo').text('ãƒã‚«ãƒãƒ³ã‚¬ãƒ¼åˆ°ç€ã¾ã§..  ' + distance.toFixed(2) + ' km');

                    if (line) {
                        line.setPath([
                            { lat: userLat, lng: userLng },
                            { lat: issLat, lng: issLng }
                        ]);
                    } else {
                        line = new google.maps.Polyline({
                            path: [
                                { lat: userLat, lng: userLng },
                                { lat: issLat, lng: issLng }
                            ],
                            geodesic: true,
                            strokeColor: '#FF0000',
                            strokeOpacity: 1.0,
                            strokeWeight: 2,
                            map: map
                        });
                    }
                }

                // ISSã®å¤©æ°—æƒ…å ±ã‚’å–å¾—ã—ã¦è¡¨ç¤ºã™ã‚‹
                getWeather(issLat, issLng, "#issWeather");

                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å¤©æ°—æƒ…å ±ã‚’å–å¾—ã—ã¦è¡¨ç¤ºã™ã‚‹
                if (userLat !== undefined && userLng !== undefined) {
                    getWeather(userLat, userLng, "#userWeather");
                }
            });

            setTimeout(updateISS, 1000); // 1ç§’ã”ã¨ã«ä½ç½®ã‚’æ›´æ–°
        }

        // å¤©æ°—æƒ…å ±ã‚’å–å¾—ã—ã¦è¡¨ç¤ºã™ã‚‹é–¢æ•°
        function getWeather(lat, lon, elementId) {
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`;

            $.getJSON(url, function (data) {
                if (data.current_weather) {
                    const weather = data.current_weather;
                    const temp = weather.temperature;
                    const windspeed = weather.windspeed;
                    $(elementId).text(`æ°—æ¸© ${temp}Â°Cã€€é¢¨é€Ÿ ${windspeed}km/h`);
                } else {
                    $(elementId).text("å¤©æ°—æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚");
                }
            });
        }

        // 2ç‚¹é–“ã®è·é›¢ã‚’è¨ˆç®—ã™ã‚‹é–¢æ•°
        function calculateDistance(lat1, lon1, lat2, lon2) {
            let R = 6371; // åœ°çƒã®åŠå¾„(km)
            let dLat = deg2rad(lat2 - lat1);
            let dLon = deg2rad(lon2 - lon1);
            let a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            let c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            let d = R * c; // è·é›¢(km)
            return d;
        }

        // åº¦ã‚’ãƒ©ã‚¸ã‚¢ãƒ³ã«å¤‰æ›ã™ã‚‹é–¢æ•°
        function deg2rad(deg) {
            return deg * (Math.PI / 180)
        }

        // ä½ç½®æƒ…å ±ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°é–¢æ•°
        function handleLocationError(browserHasGeolocation, pos) {
            alert(browserHasGeolocation ?
                'ã‚¨ãƒ©ãƒ¼: Geolocationã‚µãƒ¼ãƒ“ã‚¹ãŒå¤±æ•—ã—ã¾ã—ãŸã€‚' :
                'ã‚¨ãƒ©ãƒ¼: ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯Geolocationã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚');
        }
    </script>

    <!-- Google Maps APIã®èª­ã¿è¾¼ã¿ -->
    <script async defer src="https://maps.googleapis.com/maps/api/js?key='ã“ã“ã«API_KEYã‚’å…¥åŠ›'&callback=initMap">
    </script>

</body>

</html>